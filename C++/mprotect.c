#include <stdio.h>
#include <malloc.h>
#include <unistd.h>
#include <sys/mman.h>

int main (){
    void* start = mmap(NULL, 1024, PROT_READ | PROT_WRITE | PROT_EXEC,
                     MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    printf("%p",start);

    //byts sequence
    unsigned char code[] = {
    0x4c, 0x8b, 0x05, 0xf9, 0x0f, 0x00, 0x00, // 401000: mov 0xff9(%rip),%r8
    0x4c, 0x8b, 0x0d, 0xfa, 0x0f, 0x00, 0x00, // 401007: mov 0xffa(%rip),%r9
    0x4d, 0x01, 0xc1,                         // 40100e: add %r8,%r9
    0x4c, 0x89, 0x0d, 0xf0, 0x0f, 0x00, 0x00, // 401011: mov %r9,0xff0(%rip)
    0x48, 0x8b, 0x05, 0xe9, 0x0f, 0x00, 0x00, // 401018: mov 0xfe9(%rip),%rax
    0x48, 0x8d, 0x3d, 0xea, 0x0f, 0x00, 0x00, // 40101f: lea 0xfea(%rip),%rdi
    0xe8, 0x2a, 0x00, 0x00, 0x00,             // 401026: call 401055 <int_to_string>
    0x48, 0xc7, 0xc7, 0x01, 0x00, 0x00, 0x00, // 40102b: mov $0x1,%rdi
    0x48, 0x8d, 0x35, 0xd7, 0x0f, 0x00, 0x00, // 401032: lea 0xfd7(%rip),%rsi
    0x48, 0xc7, 0xc2, 0x0a, 0x00, 0x00, 0x00, // 401039: mov $0xa,%rdx
    0x48, 0xc7, 0xc0, 0x01, 0x00, 0x00, 0x00, // 401040: mov $0x1,%rax
    0x0f, 0x05,                               // 401047: syscall
    0x48, 0xc7, 0xc0, 0x3c, 0x00, 0x00, 0x00, // 401049: mov $0x3c,%rax
    0x48, 0x31, 0xff,                         // 401050: xor %rdi,%rdi
    0x0f, 0x05,                               // 401053: syscall

    0x48, 0xc7, 0xc1, 0x0a, 0x00, 0x00, 0x00, // 401055: mov $0xa,%rcx
    0x48, 0x89, 0xc3,                         // 40105c: mov %rax,%rbx
    0x48, 0x8d, 0x3d, 0xb3, 0x0f, 0x00, 0x00, // 40105f: lea 0xfb3(%rip),%rdi
    0xc6, 0x07, 0x00,                         // 401066: movb $0x0,(%rdi)

    0x48, 0x31, 0xd2,                         // 401069: xor %rdx,%rdx
    0x48, 0xf7, 0xf1,                         // 40106c: div %rcx
    0x80, 0xc2, 0x30,                         // 40106f: add $0x30,%dl
    0x48, 0xff, 0xcf,                         // 401072: dec %rdi
    0x88, 0x17,                               // 401075: mov %dl,(%rdi)
    0x48, 0x85, 0xc0,                         // 401077: test %rax,%rax
    0x75, 0xed,                               // 40107a: jne 401069 <.int_to_string_loop>
    0xc3                                      // 40107c: ret
};


    memcpy(start,code,sizeof(code));

    printf("\n%x",*(unsigned char *)start);

    asm ("jmp *%0"
         :
         :"r"(start)
         );
}

